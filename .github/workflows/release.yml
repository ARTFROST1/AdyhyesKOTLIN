name: üöÄ Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3
  workflow_dispatch:  # Manual trigger
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-release:
    name: üì± Build Release APK & AAB
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
      actions: read
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: üêò Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper
        
    - name: üîê Decode Keystore
      env:
        ENCODED_KEYSTORE: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        mkdir -p keystore
        if [ -z "$ENCODED_KEYSTORE" ]; then
          echo "‚ùå KEYSTORE_BASE64 secret is empty or not set"
          exit 1
        fi
        echo "üîç Keystore length: ${#ENCODED_KEYSTORE}"
        echo "$ENCODED_KEYSTORE" | base64 -d > keystore/adygyes-release.keystore
        if [ ! -f keystore/adygyes-release.keystore ]; then
          echo "‚ùå Failed to create keystore file"
          exit 1
        fi
        echo "‚úÖ Keystore decoded successfully"
        ls -la keystore/
        
    - name: üîë Create keystore.properties
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      run: |
        echo "storePassword=$KEYSTORE_PASSWORD" > keystore.properties
        echo "keyPassword=$KEY_PASSWORD" >> keystore.properties
        echo "keyAlias=$KEY_ALIAS" >> keystore.properties
        echo "storeFile=keystore/adygyes-release.keystore" >> keystore.properties
        
    - name: üóùÔ∏è Create local.properties
      env:
        YANDEX_API_KEY: ${{ secrets.YANDEX_MAPKIT_API_KEY }}
      run: |
        echo "YANDEX_MAPKIT_API_KEY=$YANDEX_API_KEY" > local.properties
        
    - name: üîß Make gradlew executable
      run: chmod +x gradlew
      
    - name: üßπ Clean build
      run: ./gradlew clean
      
    - name: üì¶ Build Release APK
      run: ./gradlew assembleFullRelease
      
    - name: üì± Build Release AAB
      run: ./gradlew bundleFullRelease
      
    - name: üîç List build outputs (debug)
      run: |
        echo "=== APK outputs ==="
        find app/build/outputs/apk -name "*.apk" -type f || echo "No APK files found"
        echo "=== AAB outputs ==="
        find app/build/outputs/bundle -name "*.aab" -type f || echo "No AAB files found"
        echo "=== All outputs ==="
        ls -la app/build/outputs/ || echo "No outputs directory"
      
    - name: üìä Get version info
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: üìù Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## üéâ AdygGIS v${{ steps.version.outputs.version }}
        
        ### ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
        - üó∫Ô∏è **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –ê–¥—ã–≥–µ–∏** —Å –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏
        - üîç **–£–º–Ω—ã–π –ø–æ–∏—Å–∫** –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º  
        - ‚≠ê **–°–∏—Å—Ç–µ–º–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ** –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Å—Ç
        - üìç **–ù–∞–≤–∏–≥–∞—Ü–∏—è** –¥–æ –ª—é–±–æ–π —Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
        - üì∏ **–ì–∞–ª–µ—Ä–µ–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π** –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
        - üåì **–¢–µ–º–Ω–∞—è –∏ —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º—ã**
        - üíæ **–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞** –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
        
        ### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:
        - –ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
        - –î–≤—É—Ö—Å–ª–æ–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ (100% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∫–ª–∏–∫–æ–≤)
        - –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
        - –ü–æ–ª–Ω–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
        
        ### üì± –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
        - Android 10+ (API 29+)
        - –†–∞–∑–º–µ—Ä: ~15-20 –ú–ë
        - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ arm64-v8a, armeabi-v7a, x86_64
        
        ---
        
        **üìß –ü–æ–¥–¥–µ—Ä–∂–∫–∞:** [–í–ê–®_EMAIL]  
        **üêõ –ë–∞–≥–∏:** [GitHub Issues](https://github.com/–í–ê–®–ï_–ò–ú–Ø/AdyhyesKOTLIN/issues)  
        **‚≠ê –ü–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å?** –û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤ –≤ Google Play!
        EOF
        
    - name: üîç Find build files
      id: find_files
      run: |
        APK_FILE=$(find app/build/outputs/apk -name "*.apk" -type f | head -1)
        AAB_FILE=$(find app/build/outputs/bundle -name "*.aab" -type f | head -1)
        
        echo "Found APK: $APK_FILE"
        echo "Found AAB: $AAB_FILE"
        
        echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
        echo "aab_file=$AAB_FILE" >> $GITHUB_OUTPUT
        
        # Verify files exist
        if [ ! -f "$APK_FILE" ]; then
          echo "‚ùå APK file not found!"
          exit 1
        fi
        if [ ! -f "$AAB_FILE" ]; then
          echo "‚ùå AAB file not found!"
          exit 1
        fi
        
        echo "‚úÖ Both files found successfully"
        
    - name: üöÄ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: AdygGIS v${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ${{ steps.find_files.outputs.apk_file }}
          ${{ steps.find_files.outputs.aab_file }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: üìä Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: AdygGIS-v${{ steps.version.outputs.version }}-APK
        path: ${{ steps.find_files.outputs.apk_file }}
        
    - name: üì± Upload AAB artifact
      uses: actions/upload-artifact@v4
      with:
        name: AdygGIS-v${{ steps.version.outputs.version }}-AAB
        path: ${{ steps.find_files.outputs.aab_file }}
