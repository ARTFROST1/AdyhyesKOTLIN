---

# üì± –ö–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **Adygyes**

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-09-26  
**–í–µ—Ä—Å–∏—è:** Stage 9 Complete + Persistent MapHost & Camera State  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã, –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤

## üü© –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äî **MapScreen —Å —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –º–∞—Ä–∫–µ—Ä–æ–≤**

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Dual-Layer Marker System - –Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∏–∑—É–∞–ª—ã + –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π Compose –æ–≤–µ—Ä–ª–µ–π

{{ ... }}
**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**

* **–ö–∞—Ä—Ç–∞ (Yandex Maps API) / –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π** (–ø–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π)
* **–ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ —Å real-time —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π** (floating Surface –Ω–∞–¥ –∫–∞—Ä—Ç–æ–π) üîç
* **–†–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã** - –¥–≤—É—Ö—Å–ª–æ–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –∏–¥–µ–∞–ª—å–Ω–æ–π –ø—Ä–∏–≤—è–∑–∫–æ–π –∏ 100% –∫–ª–∏–∫–∞–º–∏
* **–ì–µ–æ–æ–±—ä–µ–∫—Ç—ã** (–º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –ø–∞—Ä–∫–æ–≤, –ª–∏–Ω–∏–∏ —Ç—Ä–æ–ø, –≤–æ–¥–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)
* **–ö–Ω–æ–ø–∫–∞ "–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"** —Å GPS –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º üìç
* **Edge-to-edge –¥–∏–∑–∞–π–Ω** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ WindowInsets
* **–ù–∏–∂–Ω–µ–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é** (Material Design 3):
  - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞ (–∫–∞—Ä—Ç–∞/—Å–ø–∏—Å–æ–∫) üìã —Å –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏
  - –ò–∑–±—Ä–∞–Ω–Ω–æ–µ ‚≠ê —Å badge —Å—á–µ—Ç—á–∏–∫–æ–º
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
* **Dual-Layer Architecture** - –Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∏–∑—É–∞–ª—ã (0ms –ª–∞–≥–∞) + Compose –∫–ª–∏–∫–∏ (100% –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å)
* **Persistent MapHost** (`MapHost.kt`) - –µ–¥–∏–Ω—ã–π `MapView` –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–∞—Ä—Ç–∞ –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
* **Camera State Persistence** (`MapStateViewModel.kt`, `PreferencesManager.cameraStateFlow`) - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–µ–Ω—Ç—Ä–∞/–∑—É–º–∞/–∞–∑–∏–º—É—Ç–∞/–Ω–∞–∫–ª–æ–Ω–∞ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏
* **Marker Persistence** (`VisualMarkerRegistry.kt`) - –Ω–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –Ω–µ –æ—á–∏—â–∞—é—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
* **DualLayerMarkerSystem** - –≥–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–≤—É—Ö—Å–ª–æ–π–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
* **VisualMarkerProvider** - —Å–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∞—Å–∏–≤—ã—Ö –∫—Ä—É–≥–ª—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è MapKit —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
* **Transparent Overlay** - –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–ª–æ–π –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –∫–ª–∏–∫–æ–≤ —Å —Ç–æ—á–Ω—ã–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
* **üñºÔ∏è ImageCacheManager** - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (25% –ø–∞–º—è—Ç–∏, 250MB –¥–∏—Å–∫)
* **Hardware Bitmap Fix** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Canvas —Å `.allowHardware(false)`
* **Production Performance** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–î–µ–π—Å—Ç–≤–∏—è:**

* üîò **–í–≤–æ–¥ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞** ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ/–≤ —Å–ø–∏—Å–∫–µ (debounced)
* üîò **–ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤** ‚Üí –æ—Ç–∫—Ä—ã—Ç—å CategoryFilterBottomSheet —Å –≤—ã–±–æ—Ä–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π
* üîò **–ù–∏–∂–Ω–µ–µ –º–µ–Ω—é: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞** ‚Üí –ø–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∫–∞—Ä—Ç–∞ ‚Üî —Å–ø–∏—Å–æ–∫
* üîò **–ù–∏–∂–Ω–µ–µ –º–µ–Ω—é: –ò–∑–±—Ä–∞–Ω–Ω–æ–µ** ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ **FavoritesScreen**
* üîò **–ù–∏–∂–Ω–µ–µ –º–µ–Ω—é: –ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –≤ **SettingsScreen**
* üîò **–ö–ª–∏–∫ –ø–æ –º–µ—Ç–∫–µ/—ç–ª–µ–º–µ–Ω—Ç—É —Å–ø–∏—Å–∫–∞** ‚Üí **AttractionBottomSheet** (100% –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ)
* üîò **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ/–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã** ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
* üîò **–ö–Ω–æ–ø–∫–∞ ¬´–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ¬ª** ‚Üí —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π

---

## üü¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî **AttractionBottomSheet** (Modal Bottom Sheet)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** AttractionBottomSheet.kt —Å Material Design 3

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**

* **PhotoGallery** - –ì–∞–ª–µ—Ä–µ—è —Ñ–æ—Ç–æ —Å swipe, zoom –∏ lazy loading (–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
* **–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - Typography.headlineSmall
* **–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ** - Scrollable content —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
* **–†–µ–π—Ç–∏–Ω–≥** - RatingBar component —Å –∑–≤–µ–∑–¥–∞–º–∏ ‚≠ê
* **–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è** - –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã, —Ü–µ–Ω—ã, —Ç–µ–ª–µ—Ñ–æ–Ω
* **–ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π** (Material 3 buttons):
  * üö© **¬´–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç¬ª** ‚Üí NavigationUseCase ‚Üí –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
  * ‚≠ê **¬´–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª** ‚Üí ToggleFavorite –≤ ViewModel
  * üîó **¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª** ‚Üí ShareUseCase ‚Üí –Ω–∞—Ç–∏–≤–Ω—ã–π share sheet

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
* **ModalBottomSheet** —Å rememberModalBottomSheetState
* **key(attraction.id)** –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
* **Drag handle** –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
* **Proper dismiss handling** —Å clearSelection –≤ ViewModel

**–î–µ–π—Å—Ç–≤–∏—è:**

* **Swipe down / tap outside** ‚Üí onDismiss() ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –∫–∞—Ä—Ç—É
* **–ö–Ω–æ–ø–∫–∞ ¬´–ò–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª** ‚Üí toggleFavorite() ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
* **–ö–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª** ‚Üí shareAttraction() ‚Üí —Å–∏—Å—Ç–µ–º–Ω–æ–µ –º–µ–Ω—é
* **–ö–Ω–æ–ø–∫–∞ ¬´–ú–∞—Ä—à—Ä—É—Ç¬ª** ‚Üí navigateToAttraction() ‚Üí –≤–Ω–µ—à–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è

---

## üü® –≠–∫—Ä–∞–Ω ‚Äî **–ò–∑–±—Ä–∞–Ω–Ω–æ–µ**

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**

* –°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –º–µ—Å—Ç (–º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Ñ–æ—Ç–æ, –Ω–∞–∑–≤–∞–Ω–∏–µ–º, –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π).
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –º–µ—Å—Ç–∞.
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ.

**–î–µ–π—Å—Ç–≤–∏—è:**

* –ù–∞–∂–∞—Ç—å –Ω–∞ –º–µ—Å—Ç–æ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è **–ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**.
* –£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.

---

## üüß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî **CategoryFilterBottomSheet** (–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** CategoryFilterBottomSheet.kt —Å Material Design 3

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**

* **Header** —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º "–§–∏–ª—å—Ç—Ä—ã" –∏ –∫–Ω–æ–ø–∫–æ–π "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ"
* **LazyColumn** —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π AttractionCategory.values()
* **Checkbox** –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –≤—ã–±–æ—Ä–∞
* **Apply button** –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
* **ModalBottomSheet** —Å rememberModalBottomSheetState

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
* **Real-time filtering** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
* **State management** —á–µ—Ä–µ–∑ selectedCategories StateFlow
* **Category toggle** —á–µ—Ä–µ–∑ ViewModel.toggleCategory()
* **Persistent state** - —Ñ–∏–ª—å—Ç—Ä—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

**–î–µ–π—Å—Ç–≤–∏—è:**

* **–í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏** ‚Üí toggleCategory() ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ/—Å–ø–∏—Å–∫–µ
* **–ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"** ‚Üí onApply() ‚Üí –∑–∞–∫—Ä—ã—Ç–∏–µ bottom sheet
* **Swipe down / tap outside** ‚Üí onDismiss() ‚Üí –∑–∞–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üü• –≠–∫—Ä–∞–Ω ‚Äî **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)

**–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:**

* ‚úÖ **–Ø–∑—ã–∫** - –ü–æ–ª–Ω–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ (–≤–µ—Å—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–µ—Ä–µ–≤–µ–¥–µ–Ω), English (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞).
* ‚úÖ **–¢—ë–º–Ω–∞—è —Ç–µ–º–∞** üåô - Light/Dark/System —Ä–µ–∂–∏–º—ã.
* ‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏** - –≤–µ—Ä—Å–∏—è, —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏, —Å—Å—ã–ª–∫–∏.
* ‚úÖ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã** - –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è, —Ç—Ä–∞—Ñ–∏–∫.
* ‚úÖ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏** - –∫—ç—à, —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è.
* (–§—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è –±—É–¥—É—â–µ–≥–æ: –ø—Ä–æ—Ñ–∏–ª—å, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è).

---

# üîÑ User Flow (Unified MapScreen Architecture)
{{ ... }}
```
[MapScreen.kt - Unified Main Screen]
   ‚îÇ
   ‚îú‚îÄ‚îÄ üîç UnifiedSearchTextField (floating)
   ‚îÇ    ‚îú‚îÄ‚îÄ Real-time input ‚Üí debounced search (300ms)
   ‚îÇ    ‚îú‚îÄ‚îÄ Clear button ‚Üí onValueChange("")
   ‚îÇ    ‚îî‚îÄ‚îÄ Filter button ‚Üí CategoryFilterBottomSheet
   ‚îÇ         ‚îú‚îÄ‚îÄ Category checkboxes ‚Üí toggleCategory()
   ‚îÇ         ‚îú‚îÄ‚îÄ "Clear All" ‚Üí clearFilters()
   ‚îÇ         ‚îî‚îÄ‚îÄ "Apply" ‚Üí close sheet
   ‚îÇ
   ‚îú‚îÄ‚îÄ üì± AdygyesBottomNavigation (Material 3)
   ‚îÇ    ‚îú‚îÄ‚îÄ View Toggle üìã ‚Üí AnimatedContent(MAP ‚Üî LIST)
   ‚îÇ    ‚îú‚îÄ‚îÄ Favorites ‚≠ê (with badge) ‚Üí FavoritesScreen
   ‚îÇ    ‚îî‚îÄ‚îÄ Settings ‚öôÔ∏è ‚Üí SettingsScreen
   ‚îÇ
   ‚îú‚îÄ‚îÄ üó∫Ô∏è Map Mode (Persistent MapHost + overlay)
   ‚îÇ    ‚îú‚îÄ‚îÄ MapHost: –µ–¥–∏–Ω—ã–π MapView —Å –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∏ —Å—Ç–∏–ª—è–º–∏ (–Ω–æ—á–Ω–æ–π —Ä–µ–∂–∏–º)
   ‚îÇ    ‚îú‚îÄ‚îÄ DualLayerMarkerSystem: VisualMarkerProvider (–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã) + TransparentClickOverlay (–∫–ª–∏–∫–∏)
   ‚îÇ    ‚îú‚îÄ‚îÄ VisualMarkerRegistry: –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
   ‚îÇ    ‚îú‚îÄ‚îÄ Camera state persisted: MapStateViewModel + DataStore
   ‚îÇ    ‚îî‚îÄ‚îÄ FAB üìç ‚Üí GPS location ‚Üí camera animation
   ‚îÇ
   ‚îú‚îÄ‚îÄ üìã List Mode (AttractionsList)
   ‚îÇ    ‚îú‚îÄ‚îÄ Filtered attractions ‚Üí real-time updates
   ‚îÇ    ‚îú‚îÄ‚îÄ Item tap ‚Üí onAttractionClick()
   ‚îÇ    ‚îú‚îÄ‚îÄ Favorite toggle ‚Üí toggleFavorite()
   ‚îÇ    ‚îî‚îÄ‚îÄ WindowInsets padding ‚Üí proper layout
   ‚îÇ
   ‚îî‚îÄ‚îÄ üéØ selectedAttraction?.let ‚Üí AttractionBottomSheet
        ‚îú‚îÄ‚îÄ key(attraction.id) ‚Üí force recomposition
        ‚îú‚îÄ‚îÄ PhotoGallery ‚Üí swipe & zoom
        ‚îú‚îÄ‚îÄ Attraction details ‚Üí scrollable content
        ‚îú‚îÄ‚îÄ Action buttons:
        ‚îÇ    ‚îú‚îÄ‚îÄ üö© Route ‚Üí NavigationUseCase ‚Üí Yandex Maps
        ‚îÇ    ‚îú‚îÄ‚îÄ ‚≠ê Favorite ‚Üí toggleFavorite() ‚Üí state update
        ‚îî‚îÄ‚îÄ onDismiss ‚Üí clearSelection() ‚Üí close sheet

Technical Features:
‚îú‚îÄ‚îÄ üîß reliable marker taps (100% guaranteed)
‚îú‚îÄ‚îÄ üé® Edge-to-edge UI with WindowInsets
   178‚Üí‚îú‚îÄ‚îÄ üîÑ Proper MapKit lifecycle (handled by MapHost)
   180‚Üí‚îú‚îÄ‚îÄ ‚ö° Optimized marker updates (VisualMarkerRegistry incremental sync)
   182‚Üí‚îú‚îÄ‚îÄ Persistent MapHost (single MapView instance)
   183‚Üí‚îú‚îÄ‚îÄ Camera state persistence (MapStateViewModel + DataStore)
   184‚Üí‚îú‚îÄ‚îÄ Marker persistence (VisualMarkerRegistry + DataStore)
‚îî‚îÄ‚îÄ üé≠ Smooth animations (view mode transitions)

# üìä –ö–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **Adygyes**

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-09-27  
**–í–µ—Ä—Å–∏—è:** Stage 9 Complete + Persistent MapHost & Camera State  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã, –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
### ‚úÖ **Code Consolidation:**
- **6 MapScreen files** ‚Üí **1 unified MapScreen.kt**
- **Single source of truth** for map functionality
- **Easier maintenance** and debugging

### ‚úÖ **Reliability Improvements:**
- **100% guaranteed marker taps** with userData validation
- **Proper state management** with debug logging
- **Robust error handling** in tap listeners

### ‚úÖ **Modern UI/UX:**
- **Edge-to-edge design** with proper system insets
- **Material Design 3** components throughout
- **Smooth animations** and transitions
- **Responsive layout** for different screen sizes

### ‚úÖ **Performance Optimizations:**
- **Debounced search** (300ms) for better performance
- **Smart marker updates** to prevent unnecessary recreation
- **Efficient state management** with StateFlow
- **Proper lifecycle handling** with DisposableEffect

---

# üìå –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã UX

* **–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äî —ç—Ç–æ –∫–∞—Ä—Ç–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å–ø–∏—Å–æ–∫.**
* **–ü–æ–∏—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.
* –ú–∏–Ω–∏–º—É–º –∫–ª–∏–∫–æ–≤ –¥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–º–µ—Ç–∫–∞/—ç–ª–µ–º–µ–Ω—Ç ‚Üí –∫–∞—Ä—Ç–æ—á–∫–∞).
* –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è (–∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –º–∞—Ä—à—Ä—É—Ç—ã, –ø–æ–¥–µ–ª–∏—Ç—å—Å—è) –¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä—è–º–æ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏.
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–±–æ—Ç—ã –æ—Ñ—Ñ–ª–∞–π–Ω (–∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ + –±–∞–∑–æ–≤—ã–µ –∫–∞—Ä—Ç—ã).
* ‚úÖ **–ü–æ–ª–Ω–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫** - –≤–µ—Å—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

---

# üéØ –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (Stage 8 Complete)

## ‚úÖ **–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

### üó∫Ô∏è **Unified MapScreen:**
- ‚úÖ –ï–¥–∏–Ω—ã–π MapScreen.kt —Å –Ω–∞–¥–µ–∂–Ω—ã–º–∏ –∫–ª–∏–∫–∞–º–∏ –ø–æ –º–µ—Ç–∫–∞–º
- ‚úÖ Edge-to-edge –¥–∏–∑–∞–π–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ WindowInsets
- ‚úÖ Real-time –ø–æ–∏—Å–∫ —Å debouncing (300ms)
- ‚úÖ –ü–ª–∞–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ –∫–∞—Ä—Ç—ã/—Å–ø–∏—Å–∫–∞
- ‚úÖ Proper MapKit lifecycle —Å DisposableEffect

### üì± **Bottom Navigation:**
- ‚úÖ AdygyesBottomNavigation —Å Material Design 3
- ‚úÖ –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –∏ badge —Å—á–µ—Ç—á–∏–∫–∏
- ‚úÖ –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏ (Favorites, Settings)

### üéõÔ∏è **Components:**
- ‚úÖ AttractionBottomSheet —Å ModalBottomSheet
- ‚úÖ CategoryFilterBottomSheet –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ UnifiedSearchTextField —Å floating design
- ‚úÖ AttractionsList –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å–ø–∏—Å–∫–∞
### üíæ **Data & State:**
- ‚úÖ 10 —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ê–¥—ã–≥–µ–∏
- ‚úÖ Room database —Å offline –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
- ‚úÖ StateFlow –¥–ª—è reactive UI updates
- ‚úÖ PreferencesManager –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ **ImageCacheManager** - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### üñºÔ∏è **–°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**
- ‚úÖ **Smart Preloading** - –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –∫–∞–∂–¥–æ–π –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- ‚úÖ **Lazy Loading** - –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ –≥–∞–ª–µ—Ä–µ–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
- ‚úÖ **Version-Based Cache** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ attractions.json
- ‚úÖ **Hardware Bitmap Fix** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å Canvas –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∫–∞—Ä—Ç—ã
- ‚úÖ **Memory Optimization** - 25% –ø–∞–º—è—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è + 250MB –¥–∏—Å–∫–æ–≤–æ–≥–æ –∫—ç—à–∞
- ‚úÖ **Repository Integration** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AttractionRepositoryImpl –¥–ª—è –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## üöß **–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (Stage 10):**
- Quality Assurance & Optimization
- Firebase Crashlytics integration
- Analytics tracking
- Unit & UI testing

## üìä **–ü—Ä–æ–≥—Ä–µ—Å—Å:** 93% (123/132 –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)
* –ï–¥–∏–Ω—ã–π –ø–æ—Ç–æ–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è ‚Äî –ø–æ–∏—Å–∫ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –¥—Ä—É–≥–∏–µ —Ä–µ–≥–∏–æ–Ω—ã (–∫–∞—Ç–µ–≥–æ—Ä–∏—è ¬´–†–µ–≥–∏–æ–Ω¬ª –≤ –¥–∞–Ω–Ω—ã—Ö).